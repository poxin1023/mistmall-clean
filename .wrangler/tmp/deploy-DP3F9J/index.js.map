{
  "version": 3,
  "sources": ["../../../worker/index.ts"],
  "sourceRoot": "D:\\\u6211\u7684\u684C\u9762\\mistmall-clean\\.wrangler\\tmp\\deploy-DP3F9J",
  "sourcesContent": ["export interface Env {\r\n    DB: D1Database\r\n    ADMIN_TOKEN: string\r\n  }\r\n  \r\n  function json(data: any, init: ResponseInit = {}) {\r\n    return new Response(JSON.stringify(data), {\r\n      ...init,\r\n      headers: {\r\n        \"content-type\": \"application/json; charset=utf-8\",\r\n        \"access-control-allow-origin\": \"*\",\r\n        \"access-control-allow-methods\": \"GET,POST,OPTIONS\",\r\n        \"access-control-allow-headers\": \"content-type,authorization\",\r\n        ...(init.headers || {})\r\n      }\r\n    })\r\n  }\r\n  \r\n  function badRequest(message: string) {\r\n    return json({ ok: false, error: message }, { status: 400 })\r\n  }\r\n  \r\n  function unauthorized() {\r\n    return json({ ok: false, error: \"Unauthorized\" }, { status: 401 })\r\n  }\r\n  \r\n  function getAuthToken(req: Request) {\r\n    // \u652F\u63F4\u5169\u7A2E\u5E36\u6CD5\uFF1A\r\n    // 1) Authorization: Bearer <token>\r\n    // 2) Authorization: <token>\r\n    const h = req.headers.get(\"authorization\") || \"\"\r\n    const v = h.trim()\r\n    if (!v) return \"\"\r\n    return v.toLowerCase().startsWith(\"bearer \") ? v.slice(7).trim() : v\r\n  }\r\n  \r\n  function requireAdmin(req: Request, env: Env) {\r\n    const token = getAuthToken(req)\r\n    return token && env.ADMIN_TOKEN && token === env.ADMIN_TOKEN\r\n  }\r\n  \r\n  function toInt(v: any, fallback = 0) {\r\n    const n = typeof v === \"number\" ? v : parseInt(String(v ?? \"\"), 10)\r\n    return Number.isFinite(n) ? n : fallback\r\n  }\r\n  \r\n  type IncomingOrderBody = {\r\n    name: string\r\n    phone: string\r\n    storeNo: string\r\n    storeName: string\r\n    storeAddress: string\r\n    amount: number\r\n    items: Array<{\r\n      productName: string\r\n      qty: number\r\n      unitPrice: number\r\n      subtotal: number\r\n      specs: string[]\r\n    }>\r\n  }\r\n  \r\n  export default {\r\n    async fetch(req: Request, env: Env): Promise<Response> {\r\n      const url = new URL(req.url)\r\n  \r\n      // CORS preflight\r\n      if (req.method === \"OPTIONS\") return json({ ok: true })\r\n  \r\n      // Health check\r\n      if (url.pathname === \"/api/health\") {\r\n        return json({ ok: true })\r\n      }\r\n  \r\n      // -------------------------\r\n      // A) \u5BA2\u6236\u4E0B\u55AE\uFF1A\u5BEB\u5165 D1\r\n      // POST /api/orders\r\n      // -------------------------\r\n      if (url.pathname === \"/api/orders\" && req.method === \"POST\") {\r\n        let body: IncomingOrderBody\r\n        try {\r\n          body = (await req.json()) as IncomingOrderBody\r\n        } catch {\r\n          return badRequest(\"Invalid JSON body\")\r\n        }\r\n  \r\n        // \u57FA\u672C\u9A57\u8B49\uFF08\u907F\u514D\u7A7A\u55AE/\u58DE\u8CC7\u6599\u9032 DB\uFF09\r\n        const name = String(body?.name ?? \"\").trim()\r\n        const phone = String(body?.phone ?? \"\").trim()\r\n        const storeNo = String(body?.storeNo ?? \"\").trim()\r\n        const storeName = String(body?.storeName ?? \"\").trim()\r\n        const storeAddress = String(body?.storeAddress ?? \"\").trim()\r\n        const amount = toInt(body?.amount, 0)\r\n        const items = Array.isArray(body?.items) ? body.items : []\r\n  \r\n        if (!name) return badRequest(\"Missing name\")\r\n        if (!/^09\\d{8}$/.test(phone)) return badRequest(\"Invalid phone\")\r\n        if (!storeNo || !storeName) return badRequest(\"Missing store\")\r\n        if (!items.length) return badRequest(\"Cart is empty\")\r\n        if (amount <= 0) return badRequest(\"Invalid amount\")\r\n  \r\n        // \u8A02\u55AE\u865F\uFF1AORD + 17\u4F4D\u6642\u9593\u6233\uFF08\u8DB3\u5920\u552F\u4E00\uFF09\r\n        const orderNo = `ORD${Date.now()}`\r\n        const createdAtISO = new Date().toISOString()\r\n  \r\n        // \u4EA4\u6613\uFF1AD1 \u652F\u63F4 batch\uFF1B\u9019\u88E1\u7528 batch \u63D0\u5347\u7A69\u5B9A\u6027\r\n        const statements: D1PreparedStatement[] = []\r\n  \r\n        // orders \u4E3B\u8868\r\n        statements.push(\r\n          env.DB.prepare(\r\n            `INSERT INTO orders\r\n             (order_no, created_at, status, name, phone, store_no, store_name, store_address, amount)\r\n             VALUES (?, ?, 'pending', ?, ?, ?, ?, ?, ?)`\r\n          ).bind(orderNo, createdAtISO, name, phone, storeNo, storeName, storeAddress, amount)\r\n        )\r\n  \r\n        // order_items \u660E\u7D30\r\n        for (const it of items) {\r\n          const productName = String(it?.productName ?? \"\").trim()\r\n          const qty = toInt(it?.qty, 0)\r\n          const unitPrice = toInt(it?.unitPrice, 0)\r\n          const lineTotal = toInt(it?.subtotal, qty * unitPrice)\r\n          const specs = Array.isArray(it?.specs) ? it.specs.map(s => String(s).trim()).filter(Boolean) : []\r\n          const variantText = specs.length ? specs.join(\" / \") : \"\uFF08\u7121\uFF09\"\r\n  \r\n          if (!productName || qty <= 0 || unitPrice < 0) continue\r\n  \r\n          statements.push(\r\n            env.DB.prepare(\r\n              `INSERT INTO order_items\r\n               (order_no, product_name, variant_text, qty, unit_price, line_total)\r\n               VALUES (?, ?, ?, ?, ?, ?)`\r\n            ).bind(orderNo, productName, variantText, qty, unitPrice, lineTotal)\r\n          )\r\n        }\r\n  \r\n        // \u82E5\u660E\u7D30\u5168\u88AB\u904E\u6FFE\u6389\uFF08\u4F8B\u5982 qty \u90FD\u662F 0\uFF09\r\n        if (statements.length <= 1) return badRequest(\"No valid items\")\r\n  \r\n        try {\r\n          await env.DB.batch(statements)\r\n        } catch (e: any) {\r\n          // \u5E38\u898B\uFF1Aorder_no unique \u885D\u7A81\uFF08\u6975\u4F4E\u6A5F\u7387\uFF09\u6216 SQL \u5931\u6557\r\n          return json(\r\n            { ok: false, error: \"DB insert failed\", detail: String(e?.message ?? e) },\r\n            { status: 500 }\r\n          )\r\n        }\r\n  \r\n        return json({ ok: true, orderNo, createdAt: createdAtISO })\r\n      }\r\n  \r\n      // -------------------------\r\n      // B) \u7BA1\u7406\u5F8C\u53F0\uFF1A\u67E5\u8A02\u55AE\u5217\u8868\uFF08\u4F60\u5BC4\u8CA8\u6700\u5E38\u7528\uFF09\r\n      // GET /api/admin/orders?limit=50&offset=0&status=pending\r\n      // Authorization: Bearer <ADMIN_TOKEN>\r\n      // -------------------------\r\n      if (url.pathname === \"/api/admin/orders\" && req.method === \"GET\") {\r\n        if (!requireAdmin(req, env)) return unauthorized()\r\n  \r\n        const limit = Math.min(Math.max(toInt(url.searchParams.get(\"limit\"), 50), 1), 200)\r\n        const offset = Math.max(toInt(url.searchParams.get(\"offset\"), 0), 0)\r\n        const status = String(url.searchParams.get(\"status\") ?? \"\").trim()\r\n  \r\n        const where = status ? \"WHERE status = ?\" : \"\"\r\n        const stmt = env.DB.prepare(\r\n          `SELECT order_no, created_at, status, name, phone, store_no, store_name, store_address, amount\r\n           FROM orders\r\n           ${where}\r\n           ORDER BY created_at DESC\r\n           LIMIT ? OFFSET ?`\r\n        )\r\n  \r\n        const result = status\r\n          ? await stmt.bind(status, limit, offset).all()\r\n          : await stmt.bind(limit, offset).all()\r\n  \r\n        return json({ ok: true, items: result.results ?? [] })\r\n      }\r\n  \r\n      // -------------------------\r\n      // C) \u7BA1\u7406\u5F8C\u53F0\uFF1A\u67E5\u55AE\u7B46\u8A02\u55AE\uFF08\u542B\u660E\u7D30\uFF09\r\n      // GET /api/admin/orders/:orderNo\r\n      // Authorization: Bearer <ADMIN_TOKEN>\r\n      // -------------------------\r\n      if (url.pathname.startsWith(\"/api/admin/orders/\") && req.method === \"GET\") {\r\n        if (!requireAdmin(req, env)) return unauthorized()\r\n  \r\n        const orderNo = decodeURIComponent(url.pathname.replace(\"/api/admin/orders/\", \"\")).trim()\r\n        if (!orderNo) return badRequest(\"Missing orderNo\")\r\n  \r\n        const orderRes = await env.DB.prepare(\r\n          `SELECT order_no, created_at, status, name, phone, store_no, store_name, store_address, amount\r\n           FROM orders\r\n           WHERE order_no = ?\r\n           LIMIT 1`\r\n        ).bind(orderNo).all()\r\n  \r\n        const order = orderRes.results?.[0]\r\n        if (!order) return json({ ok: false, error: \"Order not found\" }, { status: 404 })\r\n  \r\n        const itemsRes = await env.DB.prepare(\r\n          `SELECT product_name, variant_text, qty, unit_price, line_total\r\n           FROM order_items\r\n           WHERE order_no = ?\r\n           ORDER BY id ASC`\r\n        ).bind(orderNo).all()\r\n  \r\n        return json({\r\n          ok: true,\r\n          order,\r\n          items: itemsRes.results ?? []\r\n        })\r\n      }\r\n  \r\n      // 404\r\n      return json({ ok: false, error: \"Not Found\" }, { status: 404 })\r\n    }\r\n  }\r\n  "],
  "mappings": "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",
  "names": []
}
