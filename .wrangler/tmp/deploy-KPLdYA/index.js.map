{
  "version": 3,
  "sources": ["../../../worker/index.ts"],
  "sourceRoot": "D:\\\u6211\u7684\u684C\u9762\\mistmall-clean\\.wrangler\\tmp\\deploy-KPLdYA",
  "sourcesContent": ["export interface Env {\r\n    DB: D1Database\r\n    ADMIN_TOKEN: string\r\n  }\r\n  \r\n  function json(data: any, init: ResponseInit = {}) {\r\n    return new Response(JSON.stringify(data, null, 2), {\r\n      ...init,\r\n      headers: {\r\n        \"content-type\": \"application/json; charset=utf-8\",\r\n        \"access-control-allow-origin\": \"*\",\r\n        \"access-control-allow-methods\": \"GET,POST,OPTIONS\",\r\n        \"access-control-allow-headers\": \"content-type,authorization\",\r\n        ...(init.headers || {})\r\n      }\r\n    })\r\n  }\r\n  \r\n  export default {\r\n    async fetch(req: Request, env: Env): Promise<Response> {\r\n      const url = new URL(req.url)\r\n  \r\n      if (req.method === \"OPTIONS\") return json({ ok: true })\r\n  \r\n      // \u5065\u5EB7\u6AA2\u67E5\r\n      if (url.pathname === \"/api/health\") {\r\n        return json({ ok: true })\r\n      }\r\n  \r\n      // \u5BA2\u6236\u4E0B\u55AE\r\n      if (url.pathname === \"/api/orders\" && req.method === \"POST\") {\r\n        const body = await req.json()\r\n  \r\n        const orderNo = \"ORD\" + Date.now()\r\n        const createdAt = new Date().toISOString()\r\n  \r\n        await env.DB.prepare(\r\n          `INSERT INTO orders\r\n          (order_no, created_at, status, name, phone, store_no, store_name, store_address, amount)\r\n          VALUES (?, ?, 'pending', ?, ?, ?, ?, ?, ?)`\r\n        ).bind(\r\n          orderNo,\r\n          createdAt,\r\n          body.name,\r\n          body.phone,\r\n          body.storeNo,\r\n          body.storeName,\r\n          body.storeAddress,\r\n          body.amount\r\n        ).run()\r\n  \r\n        for (const it of body.items) {\r\n          await env.DB.prepare(\r\n            `INSERT INTO order_items\r\n            (order_no, product_name, variant_text, qty, unit_price, line_total)\r\n            VALUES (?, ?, ?, ?, ?, ?)`\r\n          ).bind(\r\n            orderNo,\r\n            it.productName,\r\n            it.specs.join(\" / \"),\r\n            it.qty,\r\n            it.unitPrice,\r\n            it.subtotal\r\n          ).run()\r\n        }\r\n  \r\n        return json({ ok: true, orderNo })\r\n      }\r\n  \r\n      // \uD83D\uDD10 \u5F8C\u53F0\uFF1A\u5217\u51FA\u6240\u6709\u8A02\u55AE\uFF08\u7D66\u4F60\u51FA\u8CA8\u7528\uFF09\r\n      if (url.pathname === \"/admin/orders\" && req.method === \"GET\") {\r\n        const token = url.searchParams.get(\"token\")\r\n        if (token !== env.ADMIN_TOKEN) {\r\n          return json({ ok: false, error: \"Unauthorized\" }, { status: 401 })\r\n        }\r\n  \r\n        const orders = await env.DB.prepare(\r\n          `SELECT\r\n            order_no,\r\n            created_at,\r\n            status,\r\n            name,\r\n            phone,\r\n            store_no,\r\n            store_name,\r\n            store_address,\r\n            amount\r\n          FROM orders\r\n          ORDER BY created_at DESC`\r\n        ).all()\r\n  \r\n        return json({ ok: true, orders: orders.results })\r\n      }\r\n  \r\n      return json({ ok: false, error: \"Not Found\" }, { status: 404 })\r\n    }\r\n  }\r\n  "],
  "mappings": ";;;;AAKE,SAAS,KAAK,MAAW,OAAqB,CAAC,GAAG;AAChD,SAAO,IAAI,SAAS,KAAK,UAAU,MAAM,MAAM,CAAC,GAAG;AAAA,IACjD,GAAG;AAAA,IACH,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,+BAA+B;AAAA,MAC/B,gCAAgC;AAAA,MAChC,gCAAgC;AAAA,MAChC,GAAI,KAAK,WAAW,CAAC;AAAA,IACvB;AAAA,EACF,CAAC;AACH;AAXS;AAaT,IAAO,gBAAQ;AAAA,EACb,MAAM,MAAM,KAAc,KAA6B;AACrD,UAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAE3B,QAAI,IAAI,WAAW,UAAW,QAAO,KAAK,EAAE,IAAI,KAAK,CAAC;AAGtD,QAAI,IAAI,aAAa,eAAe;AAClC,aAAO,KAAK,EAAE,IAAI,KAAK,CAAC;AAAA,IAC1B;AAGA,QAAI,IAAI,aAAa,iBAAiB,IAAI,WAAW,QAAQ;AAC3D,YAAM,OAAO,MAAM,IAAI,KAAK;AAE5B,YAAM,UAAU,QAAQ,KAAK,IAAI;AACjC,YAAM,aAAY,oBAAI,KAAK,GAAE,YAAY;AAEzC,YAAM,IAAI,GAAG;AAAA,QACX;AAAA;AAAA;AAAA,MAGF,EAAE;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,MACP,EAAE,IAAI;AAEN,iBAAW,MAAM,KAAK,OAAO;AAC3B,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA;AAAA,QAGF,EAAE;AAAA,UACA;AAAA,UACA,GAAG;AAAA,UACH,GAAG,MAAM,KAAK,KAAK;AAAA,UACnB,GAAG;AAAA,UACH,GAAG;AAAA,UACH,GAAG;AAAA,QACL,EAAE,IAAI;AAAA,MACR;AAEA,aAAO,KAAK,EAAE,IAAI,MAAM,QAAQ,CAAC;AAAA,IACnC;AAGA,QAAI,IAAI,aAAa,mBAAmB,IAAI,WAAW,OAAO;AAC5D,YAAM,QAAQ,IAAI,aAAa,IAAI,OAAO;AAC1C,UAAI,UAAU,IAAI,aAAa;AAC7B,eAAO,KAAK,EAAE,IAAI,OAAO,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MACnE;AAEA,YAAM,SAAS,MAAM,IAAI,GAAG;AAAA,QAC1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAYF,EAAE,IAAI;AAEN,aAAO,KAAK,EAAE,IAAI,MAAM,QAAQ,OAAO,QAAQ,CAAC;AAAA,IAClD;AAEA,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAChE;AACF;",
  "names": []
}
